# Docker ch03 - 컨테이너 실전 구축 및 배포

 ## 1. 애플리케이션과 시스템 내 단일 컨테이너의 적정 비중



## 2. 컨테이너의 이식성

### 1) 커널 및 아키텍처의 차이

* 도커에서 사용되는 건테이너형 가상화 기술은 호스트 운영 체제와 커널 리소스를 공유한다. 따라서 도커 컨테이너를 실행하려면 호스트가 특정 CPU 아키텍쳐 혹은 운영 체제를 사용해야 한다

### 2) 라이브러리와 동적 링크 문제

* 정적 링크와 동적 링크의 차이

```
1. 정적 링크
	1) 형태 : 애플리케이션에 사용된 라이브러리를 내부에 포함하는 형태
	2) 특징
		(1) 애플리케이션의 크기가 비대해진다
		(2) 이식성이 뛰어나다
2. 동적 링크
	1) 형태 : 애플리케이션을 실행할 때 라이브러리가 링크된다
	2) 특징
		(1) 애플리케이션 크기가 작아진다
		(2) 애플리케이션을 실행할 호스트에서 라이브러리를 갖춰야 한다
```

## 3. 도커 친화적인 애플리케이션

이식성이 높은 애플리케이션을 구축하기 위해 필요한 요소

### 1) 환경 변수 활용

도커 컨테이너 형태로 실행되는 애플리케이션의 동작을 제어하는 방법

```
1. 실행 시 인자
2. 설정 파일
3. 애플리케이션 동작을 환경 변수로 제어
4. 설정 파일에 환경 변수를 포함
```

#### (1) 실행 시 인자를 사용

```
1. 장점
	1) 외부에서 값을 주입받을 수 있다.
2. 단점
	1) 실행 시 인자가 너무 많아지면 애플리케이션에서 인자를 내부 변수로 매핑해주는 처리가 복잡해진다
	2) 실행 시 인자가 너무 많아지면 CMD 및 ENTRYPOINT 인스트럭션 내용을 관리하기가 어려워 질 수 있다
```

#### (2) 설정 파일 사용

```
1. 방법 : 실행할 애플리케이션에 환경 이름을 부여하고 그에 따른 설정 파일을 바꿔가며 사용하는 방법
2. 장점
3. 단점
	1) 특정 환경에 대한 설정 파일을 도커 이미지에 포함시키면 이식성을 저하시킨다
	2) 다른 환경에서 애플리케이션을 실행하려면 컨테이너에 해당 설정 파일을 추가해야 하므로 그때마다 새로 이미지를 빌드해야 한다
```

#### (3) 애플리케이션 동작을 환경 변수로 제어

```
1 장점
	1) 매번 이미지를 다시 빌드하지 않아도 된다
2. 단점
	1) 환경 변수의 특성상 키-값 쌍 형태인 계층 구조를 가지기 어렵다
```

#### (4) 설정 파일에 환경 변수를 포함

```
1. 방법 : 환경별 설정 파일을 애플리케이션에 포함하는 대신에 설정 파일 템플릿에 한경 변수를 포함
```

## 4. 퍼시스턴스 데이터를 다루는 방법

* `data volume` : 새로운 버젼의 컨테이너가 배포되어도 이전 버전의 컨테이너에서 사용하던 파일 및 디렉터리를 그대로 이어받아 사용할 수 있게 하는 것 1) 데이터 볼륨

* 데이터 볼륨 : 컨테이너와 호스트 사이의 디렉터리를 공유

* 데이터 볼륨 생성

```powershell
docker container run [options] -v 호스트_디렉터리:컨테이너_디렉터리 리포지토리명[:태그] [명령] [명령인자]
```

### 2) 데이터 볼륨 컨테이너

* 데이터 볼륨 컨테이너 : 컨테이너 간에 디렉터리 공유

## 5. 컨테이너 배치 전략

컨테이너를 배치하는 방법과 하나 이상의 도커 호스트를 다루는 방법

### 1) 도커 스웜

```
1. compose : 여러 컨테이너로 구성된 도커 애플리케이션을 관리
2. swarm : 클러스터 구축 및 관리
3. service : 스웜에서 클러스터 간의 서비스를 관리
4. stack : 스웜에서 여러 개의 서비스를 합한 전체 애플리케이션을 관리
```

#### (1) 여러 대의 도커 호스트로 스웜 클러스터 구성하기

* `dind(docker in docker)` : 도커 컨테이너 안에서 도커 호스트를 실행할 수 있는 기능

```powershell
1. docker-compose up -d
2. docker container exec -it manager docker swarm init
3. docker container exec -it node1 docker swarm join --token...
```

#### (2) 도커 레지스트리에 이미지 등록하기

```powershell
1. docker image tag 사용할_이미지_이름 등록할_이미지_이름
2. docker image push push_대상_리포지토리명[:태그명]
3. docker image pull pull_대상_리포지토리명[:태그명]
```



### 2) 서비스

* 서비스 : 애플리케이션을 구성하는 일부 컨테이너를 제어하기 위한 단위

### 3) 스택

* 스택 : 하나 이상의 서비스를 그룹으로 묶은 단위로서 애플리케이션 전체 구성을 정의한다. 스택은 스웜에서 동작하는 스케일 인, 스케일 아웃, 제약 조건 부여가 가능한 컴포즈다.
* overlay network : 여러 도커 호스트에 걸쳐 배포된 컨테이너 그룹을 같은 네트워크에 배치하기 위한 기술이다. 

```powershell
docker container exec -it manager docker network create --drvier=overlay --attachable 네트워크이름
```

* stack 하위 명령어

```
1. deploy : 스택을 새로 배포 혹은 업데이트
2. ls : 배포된 스택의 목록을 출력
3. ps : 스택에 의해 배포된 컨테이너의 목록을 출력
4. rm : 배포된 스택을 삭제
5. services : 스택에 포함된 서비스 목록을 출력
```

#### (1) 스택 배포하기

```powershell
docker stack deploy [options] 스택명
-c : 스택_정의파일_경로
```

#### (2) 배포된 스택 확인하기

```powershell
docker stack service [options] 스택명
```

#### (3) 스택에 배포된 컨테이너 확인하기

```powershell
docker stack ps [options] 스택명
```

#### (4) visualizer를 사용해 컨테이너 배치 시각화하기

#### (5) 스택 삭제하기

```powershell
docker stack rm 스택명
```

### 4) 스웜 클러스터 외부에서 서비스 사용하기